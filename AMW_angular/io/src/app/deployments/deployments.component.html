<app-loading-indicator [isLoading]="isLoading()"></app-loading-indicator>
<app-page>
  <div class="page-title">Deployments</div>
  <div class="page-content">
    <div>
      @if (successMessage) {
        <app-notification [message]="successMessage" [messageType]="'success'"></app-notification>
      }
      @if (errorMessage) {
        <app-notification [message]="errorMessage" [messageType]="'warning'"></app-notification>
      }

      <div>
        <div class="form-group row">
          <label for="selectFilterType" class="col-sm-1">Add filter</label>
          <div class="col-sm-10">
            <select
              id="selectFilterType"
              #selectModel="ngModel"
              class="form-select"
              [(ngModel)]="selectedFilterType"
              (change)="addFilter()"
            >
              @for (filterType of filterTypes(); track filterType.name) {
                <option [ngValue]="filterType">{{ filterType.name }}</option>
              }
            </select>
          </div>
        </div>

        @if (filters().length > 0) {
          @for (filter of filters(); track $index; let i = $index) {
            <app-deployment-filter
              [filter]="filter"
              [index]="i"
              [type]="getFilterType(filter.name) || ''"
              [compOptions]="comparatorOptionsForFilterType(getFilterType(filter.name) || '')"
              (remove)="removeFilter($event)"
            >
            </app-deployment-filter>
          }
        }

        <div class="form-group row">
          <div class="col-sm-11 offset-1">
            <app-button [variant]="'primary'" [additionalClasses]="'mb-2 me-2'" (click)="applyFilters()"
              >Apply filter</app-button
            >
            <app-button
              [variant]="'danger'"
              [additionalClasses]="'mb-2 me-2'"
              [disabled]="filters().length < 1"
              (click)="clearFilters()"
            >
              Clear filters</app-button
            >
            <app-button
              [variant]="'secondary'"
              [additionalClasses]="'mb-2 me-2'"
              [disabled]="filters().length < 1"
              (click)="copyURL()"
              ><app-icon icon="clipboard"></app-icon> Clipboard</app-button
            >
            <app-button
              [variant]="'secondary'"
              [additionalClasses]="'mb-2 me-2'"
              [disabled]="deployments().length < 1"
              (click)="exportCSV()"
              ><app-icon icon="cloud-arrow-down"></app-icon> Export</app-button
            >
            <app-button
              [variant]="'secondary'"
              [additionalClasses]="'mb-2 me-2'"
              [disabled]="!editableDeployments()"
              (click)="showEdit()"
              ><app-icon icon="pencil-square"></app-icon> Edit</app-button
            >
            @if (hasPermissionToRequestDeployments) {
              <a href="#/deployment/">
                <app-button [variant]="'secondary'" [additionalClasses]="'mb-2 me-2'" [dataTestId]="'create-button'"
                  ><app-icon icon="plus-circle"></app-icon> Create</app-button
                >
              </a>
            }
          </div>
        </div>

        <div class="form-group row">
          <label class="col-sm-1">Auto refresh</label>
          <div class="col-auto">
            <div class="input-group">
              <select
                class="form-select"
                id="selectInterval"
                aria-describedby="seconds"
                required
                [(ngModel)]="refreshInterval"
                (change)="autoRefresh()"
              >
                @for (interval of refreshIntervals; track interval) {
                  <option>{{ interval }}</option>
                }
              </select>
              <span class="input-group-text" id="seconds">Seconds</span>
            </div>
          </div>
        </div>

        @if (deployments().length > 0) {
          <div class="form-group row">
            <div>
              <div class="border border-muted rounded">
                <app-deployments-list
                  [deployments]="deployments()"
                  [sortCol]="sortCol"
                  [sortDirection]="sortDirection"
                  [filtersForParam]="filters()"
                  (doConfirmDeployment)="confirmDeployment($event)"
                  (doCancelDeployment)="cancelDeployment($event)"
                  (doRejectDeployment)="rejectDeployment($event)"
                  (editDeploymentDate)="changeDeploymentDate($event)"
                  (selectAllDeployments)="switchDeployments($event)"
                  (doSort)="sortDeploymentsBy($event)"
                >
                </app-deployments-list>
                <div class="bg-light">
                  <app-pagination
                    [currentPage]="currentPage"
                    [lastPage]="lastPage"
                    (doSetMax)="setMaxResultsPerPage($event)"
                    (doSetOffset)="setNewOffset($event)"
                  >
                  </app-pagination>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</app-page>
