<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:a4j="http://richfaces.org/a4j"
      xmlns:rich="http://richfaces.org/rich"
      xmlns:mobi="http://java.sun.com/jsf/composite/mobi">

<ui:composition template="templates/template.xhtml">
    <f:metadata>
        <f:event type="preRenderView" listener="#{deployScreenDataProvider.initView}"></f:event>
        <f:viewParam name="application_name" value="#{deployScreenDataProvider.filterApplicationNameViewParam}"/>
        <f:viewParam name="appserver_name" value="#{deployScreenDataProvider.filterAppServerNameViewParam}"/>
        <f:viewParam name="environment_name" value="#{deployScreenDataProvider.filterEnvironmentNameParam}"/>
        <f:viewParam name="tracking_id" value="#{deployScreenDataProvider.filterTrackingIdParam}"/>
    </f:metadata>
    <ui:param name="screen" value="newDeploy"/>
    <ui:define name="title">Deploy</ui:define>
    <ui:define name="pagetitle">
        <h:outputText id="pageheader" value="Deploy"/>
    </ui:define>

    <ui:define name="body">
        <h:panelGroup layout="block" id="navig">
            <aside>
                <nav>
                    <ul>
                        <li class="current"><h:commandLink value="Deployments"
                                                           execute="@none"/></li>
                    </ul>

                </nav>
            </aside>
        </h:panelGroup>
        <section id="content">
            <div class="container">

                <h:panelGroup id="contentPanelGroup"
                              rendered="#{securityDataProvider.hasPermissionOnAllContext('DEPLOYMENT', 'READ')}">

                    <article>
                        <div class="well withHeight autoOverflow">


                            <ui:include src="components/customFilterComp.xhtml">
                                <ui:param name="customFilterImpl"
                                          value="#{deployScreenDataProvider.customFilterComp}"/>
                            </ui:include>

                            <h:panelGroup id="deployments">
                                <h:dataTable var="deployment" id="deploymentsTable"
                                             value="#{deployScreenDataProvider.pendingDeployments}"
                                             styleClass="deployTable well" rowClasses="odd-row,even-row">

                                    <f:facet name="caption">
                                        <nav class="actionbar">
                                            <ul>
                                                <li>
                                                    <h:commandLink type="submit" styleClass="btn light"
                                                                   onclick="showLoader();"
                                                                   oncomplete="hideLoader();"
                                                                   actionListener="#{deployScreenDataProvider.reloadDeployments(true)}">
                                                        <i class="icon icon-reload"/>
                                                        <h:outputText value="Apply filter / Refresh"/>

                                                        <f:param name="application_name"
                                                                 value="${deployScreenDataProvider.filterApplicationNameViewParam}"/>
                                                        <f:param name="appserver_name"
                                                                 value="${deployScreenDataProvider.filterAppServerNameViewParam}"/>
                                                        <f:param name="environment_name"
                                                                 value="${deployScreenDataProvider.filterEnvironmentNameParam}"/>
                                                    </h:commandLink>
                                                </li>
                                                <li><h:outputLink styleClass="btn light" target="_blank"
                                                                  rendered="#{securityDataProvider.hasPermissionToExportDeployments()}"
                                                                  value="../deploymentCsvExport">
                                                    <i class="icon icon-csv"/>
                                                    <h:outputText value="Export"/>
                                                </h:outputLink>
                                                </li>
                                                <li>
                                                    <h:commandLink styleClass="btn disable" value="Edit" disabled="true"
                                                                   rendered="#{!deployScreenDataProvider.canEditDeployments()}">
                                                        <i class="icon icon-edit"/>
                                                    </h:commandLink>
                                                    <a4j:commandLink styleClass="btn light" value="Edit"
                                                                     rendered="#{deployScreenDataProvider.canEditDeployments()}"
                                                                     render="bulkEditPopupPanelGroup"
                                                                     actionListener="#{deployScreenDataProvider.clearEditDeploymentValues()}"
                                                                     oncomplete="#{rich:component('bulkEditPopupPanel')}.show();">
                                                        <i class="icon icon-edit"/>
                                                    </a4j:commandLink>
                                                </li>
                                                <li>
                                                    <h:link outcome="redeploy" rendered="#{deployScreenDataProvider.canRedeploy()}"
                                                            styleClass="btn light">
                                                        <i class="icon icon-redeploy">Redeploy</i>
                                                        <f:param name="deploymentIdArray"
                                                                 value="#{deployScreenDataProvider.getSelectedDeploymentIdsAsCommaseparatedList()}"/>
                                                    </h:link>
                                                </li>
                                                <li>
                                                    <h:link outcome="createDeploymentView" value="Add deployment"
                                                            rendered="#{securityDataProvider.hasPermissionToCreateDeployment() and !deployScreenDataProvider.isAngularEnabled()}"
                                                            styleClass="btn light"
                                                            onclick="showLoader();confirmLeave(event);">
                                                        <i class="icon icon-add"/>
                                                    </h:link>
                                                    <h:outputLink value="/AMW_angular/#/deployment"
                                                            rendered="#{securityDataProvider.hasPermissionToCreateDeployment() and deployScreenDataProvider.isAngularEnabled()}"
                                                            styleClass="btn light"
                                                            onclick="showLoader();confirmLeave(event);">
                                                        <i class="icon icon-add"/>
                                                        <h:outputText value="Add deployment" />
                                                    </h:outputLink>
                                                </li>
                                            </ul>
                                        </nav>
                                        <h2>
                                            <h:outputText value="Deployments"/>
                                        </h2>
                                    </f:facet>

                                    <f:facet name="footer">
                                        <h:panelGroup>
                                            <a4j:commandLink value="&lt;&lt;" render="deployments"
                                                             onclick="showLoader();" oncomplete="hideLoader();"
                                                             action="${deployScreenDataProvider.firstScreen()}"
                                                             rendered="${deployScreenDataProvider.currentPage!=0}"/>
                                            <a4j:commandLink value="&lt;" render="deployments"
                                                             onclick="showLoader();" oncomplete="hideLoader();"
                                                             action="${deployScreenDataProvider.previousScreen()}"
                                                             rendered="${deployScreenDataProvider.currentPage!=0}"
                                                             styleClass="marginLeft10"/>

                                            <ui:repeat
                                                    value="${deployScreenDataProvider.availablePages().subList(
									 deployScreenDataProvider.currentPage-2 > 0 ? deployScreenDataProvider.currentPage-2 : 0,
									 deployScreenDataProvider.availablePages().size() >= deployScreenDataProvider.currentPage+3 ? deployScreenDataProvider.currentPage + 3 : deployScreenDataProvider.availablePages().size())
									 }"
                                                    var="page">
                                                <a4j:commandLink
                                                        rendered="${page!=deployScreenDataProvider.currentPage}"
                                                        value="${page+1}" styleClass="marginLeft10"
                                                        onclick="showLoader();" oncomplete="hideLoader();"
                                                        render="deployments"
                                                        action="${deployScreenDataProvider.goToScreen(page)}"/>
                                                <h:outputText
                                                        rendered="${page==deployScreenDataProvider.currentPage}"
                                                        value="${page+1}" styleClass="marginLeft10 boldFont"/>
                                            </ui:repeat>

                                            <a4j:commandLink value="&gt;" styleClass="marginLeft10"
                                                             action="${deployScreenDataProvider.nextScreen()}"
                                                             onclick="showLoader();" oncomplete="hideLoader();"
                                                             render="deployments"
                                                             rendered="${!deployScreenDataProvider.lastPage}"/>
                                            <a4j:commandLink value="&gt;&gt;" styleClass="marginLeft10"
                                                             onclick="showLoader();" oncomplete="hideLoader();"
                                                             action="${deployScreenDataProvider.lastScreen()}"
                                                             render="deployments"
                                                             rendered="${!deployScreenDataProvider.lastPage}"/>
                                            <div class="control-group right">
                                                <label class="control-label">Results per page:</label>
                                                <div class="controls">
                                                    <h:selectOneMenu
                                                            value="#{deployScreenDataProvider.itemsPerPage}">
                                                        <f:selectItem itemLabel="10" itemValue="10"/>
                                                        <f:selectItem itemLabel="20" itemValue="20"/>
                                                        <f:selectItem itemLabel="50" itemValue="50"/>
                                                        <f:selectItem itemLabel="100" itemValue="100"/>
                                                        <a4j:ajax render="deployments"/>
                                                    </h:selectOneMenu>
                                                </div>
                                            </div>

                                        </h:panelGroup>
                                    </f:facet>


                                    <h:column index="index" headerClass="width_20 nowrap">
                                        <f:facet name="header">
                                            <h:selectBooleanCheckbox class="deploy-checkbox"
                                                                     value="#{deployScreenDataProvider.toggleDeploymentsSelection}">
                                                <a4j:ajax render="deployments" onbegin="showLoader()"
                                                          oncomplete="hideLoader()"/>
                                            </h:selectBooleanCheckbox>
                                            <a4j:commandLink render="deployments" onclick="showLoader();"
                                                             oncomplete="hideLoader();"
                                                             action="#{deployScreenDataProvider.changeSortOrderForSelectedColumn('TRACKING_ID')}">
                                                <i class="${deployScreenDataProvider.getSortingIconForCol('TRACKING_ID')} inlineBlockMiddle"></i>
                                            </a4j:commandLink>
                                        </f:facet>
                                        <h:panelGroup class="nowrap">
                                            <h:selectBooleanCheckbox class="deploy-checkbox"
                                                                     value="#{deployScreenDataProvider.checkedDeployments[deployment.id]}"
                                                                     disabled="#{!deployScreenDataProvider.isRedeployPossible(deployment)}">
                                                <a4j:ajax render="deployments"/>
                                            </h:selectBooleanCheckbox>
                                            <h:outputText value="#{deployment.trackingId}"/>
                                        </h:panelGroup>
                                    </h:column>

                                    <h:column index="index" headerClass="width_200 nowrap">
                                        <f:facet name="header">
                                            <h:outputText value="State"/>
                                            <a4j:commandLink render="deployments" onclick="showLoader();"
                                                             oncomplete="hideLoader();"
                                                             action="#{deployScreenDataProvider.changeSortOrderForSelectedColumn('STATE')}">
                                                <i class="${deployScreenDataProvider.getSortingIconForCol('STATE')} inlineBlockMiddle"></i>
                                            </a4j:commandLink>
                                        </f:facet>
                                        <div class="deploymentInfo nowrap">
                                            <h:outputText rendered="${deployment.reason == null}"
                                                    value="#{deployScreenDataProvider.getDeploymentStateText(deployment)}"
                                                    styleClass="#{deployScreenDataProvider.getDeploymentStateFrame(deployment)} inlineBlock"
                                            />
                                            <h:outputText rendered="${deployment.reason != null}"
                                                          value="#{deployment.reason.displayName}"
                                                          styleClass="#{deployScreenDataProvider.getDeploymentStateFrame(deployment)} inlineBlock reason"
                                            />
                                            <a4j:commandLink
                                                    oncomplete="#{rich:component('deploymentDetailPopup')}.show(); return false;"
                                                    render="deploymentDetailPopupFacet, deploymentDetailPopupPanelGroup"
                                                    title="Show details about this deployment"
                                                    styleClass="simpleInfo">
                                                <i class="icon icon-info inlineBlockMiddle marginLeft10 height16"></i>
                                                <a4j:param assignTo="#{deployScreenDataProvider.selectedDeploymentId}"
                                                        value="${deployment.id}"></a4j:param>
                                            </a4j:commandLink>
                                            <a4j:commandLink
                                                    rendered="#{deployScreenDataProvider.showBuildFailed(deployment)}"
                                                    oncomplete="#{rich:component('deploymentDetailPopup')}.show(); return false;"
                                                    styleClass="icon icon-build-failed inlineBlockMiddleheight16 width16"
                                                    title="Simulation failed"
                                                    render="deploymentDetailPopupFacet, deploymentDetailPopupPanelGroup">
                                                <a4j:param assignTo="#{deployScreenDataProvider.selectedDeploymentId}"
                                                        value="${deployment.id}"></a4j:param>
                                            </a4j:commandLink>
                                        </div>
                                    </h:column>

                                    <h:column index="index" headerClass="nowrap">
                                        <f:facet name="header">
                                            <h:outputText value="App Server"/>
                                            <a4j:commandLink render="deployments" onclick="showLoader();"
                                                             oncomplete="hideLoader();"
                                                             action="#{deployScreenDataProvider.changeSortOrderForSelectedColumn('APPSERVER_NAME')}">
                                                <i class="${deployScreenDataProvider.getSortingIconForCol('APPSERVER_NAME')} inlineBlockMiddle"></i>
                                            </a4j:commandLink>
                                        </f:facet>

                                        <mobi:editResourceLink rendered="#{deployment.resourceGroup != null and deployment.resource != null}" resId="#{deployment.resource.id}"
                                                               linkLabel="#{deployment.resourceGroup.name}"
                                                               editPermission="RESOURCE" resourceType="APPLICATIONSERVER"/>
                                        <h:outputText rendered="#{deployment.resourceGroup == null}"
                                                      value="#{deployScreenDataProvider.getResourceGroupName(deployment)}" />
                                        <h:outputText rendered="#{deployment.resource == null}"
                                                      value="#{deployScreenDataProvider.getResourceName(deployment)}" />

                                        <ui:repeat var="appToShow"
                                                   value="${deployment.applicationsWithVersion}">
                                            <h:panelGroup styleClass="paddingLeft20" layout="block">
                                                <mobi:editResourceLink resId="#{appToShow.applicationId}"
                                                                       linkLabel="#{appToShow.applicationName}"
                                                                       editPermission="RESOURCE" resourceType="APPLICATION"/>
                                                <h:outputText rendered="${appToShow.version != ''}"
                                                              value=" (${appToShow.version})"
                                                              styleClass="grey marginLeft10"/>
                                            </h:panelGroup>
                                        </ui:repeat>


                                    </h:column>

                                    <h:column index="index" headerClass="width_80 nowrap">
                                        <f:facet name="header">
                                            <h:outputText value="Release"/>
                                            <a4j:commandLink render="deployments" onclick="showLoader();"
                                                             oncomplete="hideLoader();"
                                                             action="#{deployScreenDataProvider.changeSortOrderForSelectedColumn('RELEASE')}">
                                                <i class="${deployScreenDataProvider.getSortingIconForCol('RELEASE')} inlineBlockMiddle"></i>
                                            </a4j:commandLink>
                                        </f:facet>

                                        <h:outputText rendered="#{deployment.release != null}" value="#{deployment.release.name}"/>
                                        <h:outputText rendered="#{deployment.release == null}" value="#{deployScreenDataProvider.getReleaseName(deployment)}"/>
                                    </h:column>

                                    <h:column index="index" headerClass="width_20 nowrap">
                                        <f:facet name="header">
                                            <h:outputText value="Env"/>
                                            <a4j:commandLink render="deployments" onclick="showLoader();"
                                                             oncomplete="hideLoader();"
                                                             action="#{deployScreenDataProvider.changeSortOrderForSelectedColumn('ENV')}">
                                                <i class="${deployScreenDataProvider.getSortingIconForCol('ENV')} inlineBlockMiddle"></i>
                                            </a4j:commandLink>
                                        </f:facet>

                                        <h:outputText rendered="#{deployment.context != null}" value="#{deployment.context.name}"
                                                      styleClass="boldFont"/>
                                        <h:outputText rendered="#{deployment.context == null}" value="#{deployScreenDataProvider.getContextName(deployment)}"
                                                      styleClass="boldFont"/>
                                    </h:column>

                                    <h:column index="index" headerClass="width_160 nowrap">
                                        <f:facet name="header">
                                            <h:outputText value="deployment date"/>
                                            <a4j:commandLink render="deployments" onclick="showLoader();"
                                                             oncomplete="hideLoader();"
                                                             action="#{deployScreenDataProvider.changeSortOrderForSelectedColumn('DEPLOY_TIME')}">
                                                <i class="${deployScreenDataProvider.getSortingIconForCol('DEPLOY_TIME')} inlineBlockMiddle"></i>

                                            </a4j:commandLink>
                                        </f:facet>

                                        <div>
                                            <h:outputText
                                                    rendered="#{!deployScreenDataProvider.isChangeDeploymentDatePossible(deployment)}"
                                                    value="#{deployScreenDataProvider.formatDate(deployment.deploymentDate)}"
                                                    styleClass="#{deployScreenDataProvider.getDeploymentDelayedClass(deployment)} inlineBlock"/>

                                            <a4j:commandLink
                                                    rendered="${deployScreenDataProvider.isChangeDeploymentDatePossible(deployment)}"
                                                    oncomplete="#{rich:component('changeDeploymentDatePopupPanel')}.show(); return false;"
                                                    render="changeDeploymentDatePopupPanelFacet, changeDeploymentDatePopupPanelGroup"
                                                    title="change the deployment date">
                                                <h:outputText
                                                        value="#{deployScreenDataProvider.formatDate(deployment.deploymentDate)}"
                                                        styleClass="#{deployScreenDataProvider.getDeploymentDelayedClass(deployment)} inlineBlock"/>
                                                <a4j:param assignTo="#{deployScreenDataProvider.selectedDeploymentId}"
                                                        value="${deployment.id}"></a4j:param>
                                            </a4j:commandLink>
                                        </div>
                                    </h:column>

                                    <h:column index="index">
                                        <f:facet name="header">
                                            <h:outputText value="actions"/>
                                        </f:facet>

                                        <a4j:commandLink
                                                rendered="${deployScreenDataProvider.isConfirmPossible(deployment)}"
                                                oncomplete="#{rich:component('confirmDeployment')}.show(); return false;"
                                                render="confirmDeploymentPopupPanelFacet, confirmDeploymentPopupPanelGroup"
                                                styleClass="green deployment-action">
                                            <i class="icon icon-success inlineBlockMiddle height20">confirm</i>
                                            <a4j:param assignTo="#{deployScreenDataProvider.selectedDeploymentId}"
                                                    value="${deployment.id}"></a4j:param>
                                        </a4j:commandLink>

                                        <a4j:commandLink
                                                rendered="${deployScreenDataProvider.isRejectPossible(deployment)}"
                                                oncomplete="#{rich:component('rejectDeployment')}.show(); return false;"
                                                render="rejectDeploymentPopupPanelFacet, rejectDeploymentPopupPanelGroup"
                                                styleClass="red deployment-action">
                                            <i class="icon icon-failed height20 inlineBlockMiddle">reject</i>
                                            <a4j:param assignTo="#{deployScreenDataProvider.selectedDeploymentId}"
                                                    value="${deployment.id}"></a4j:param>
                                        </a4j:commandLink>

                                        <a4j:commandLink
                                                rendered="${deployScreenDataProvider.isCancelPossible(deployment)}"
                                                oncomplete="#{rich:component('cancelDeployment')}.show(); return false;"
                                                render="cancelDeploymentPopupPanelFacet, cancelDeploymentPopupPanelGroup"
                                                styleClass="black deployment-action">
                                            <i class="icon icon-canceled height20 inlineBlockMiddle">cancel</i>
                                            <a4j:param assignTo="#{deployScreenDataProvider.selectedDeploymentId}"
                                                    value="${deployment.id}"></a4j:param>
                                        </a4j:commandLink>

                                        <h:link outcome="redeploy"
                                                rendered="#{deployScreenDataProvider.isRedeployPossible(deployment)
                                                and !deployScreenDataProvider.isAngularEnabled()}"
                                                styleClass="black deployment-action">
                                            <i class="icon icon-redeploy height20 inlineBlockMiddle">Redeploy</i>
                                            <f:param name="deploymentIdArray" value="#{deployment.id}"/>
                                        </h:link>
                                        <h:outputLink value="/AMW_angular/#/deployment/#{deployment.id}"
                                                      rendered="#{deployScreenDataProvider.isRedeployPossible(deployment)
                                                      and deployScreenDataProvider.isAngularEnabled()}"
                                                      styleClass="black deployment-action">
                                            <i class="icon icon-redeploy height20 inlineBlockMiddle">Redeploy</i>
                                        </h:outputLink>

                                        <h:link rendered="${deployScreenDataProvider.hasLogFiles(deployment.id)}"
                                                styleClass="deployment-action"
                                                outcome="logView">
                                            <i class="icon icon-open_logfile height20 inlineBlockMiddle">logs</i>
                                            <f:param name="deploymentId" value="${deployment.id}"/>
                                        </h:link>

                                    </h:column>
                                </h:dataTable>
                            </h:panelGroup>
                        </div>
                    </article>
                </h:panelGroup>
            </div>
        </section>
    </ui:define>

    <ui:define name="component_popups">
        <h:form>
            <rich:popupPanel id="confirmDeployment" moveable="true" autosized="true" domElementAttachment="form">
                <f:facet name="header">
                    <h2>
                        <h:outputText id="confirmDeploymentPopupPanelFacet"
                                      value="Confirm deployment ${deployScreenDataProvider.selectedDeployment.id} for appserver ${deployScreenDataProvider.selectedDeployment.resourceGroup.name}"/>
                    </h2>
                </f:facet>
                <f:facet name="controls">
                    <h:outputLink value="#"
                                  styleClass="close icon icon-close icon-replace"
                                  onclick="#{rich:component('confirmDeployment')}.hide(); return false;">
                        x
                    </h:outputLink>
                </f:facet>
                <h:panelGroup id="confirmDeploymentPopupPanelGroup">
                    <div>
                        <label class="inlineBlock">
                            <h:selectBooleanCheckbox value="#{deployScreenDataProvider.selectedDeployment.sendEmailConfirmation}"/>
                            send an email when deployed
                        </label>
                    </div>

                    <div>
                        <label class="inlineBlock">
                            <h:selectBooleanCheckbox value="#{deployScreenDataProvider.selectedDeployment.simulating}"/>
                            simulate before deployment
                        </label>
                    </div>

                    <div>
                        <h:panelGroup rendered="#{securityDataProvider.hasPermission('SHAKEDOWNTEST', 'CREATE')}">
                            <label class="inlineBlock">
                                <h:selectBooleanCheckbox value="#{deployScreenDataProvider.selectedDeployment.createTestAfterDeployment}">
                                <a4j:ajax render="testNeighbourhoodButtonId"/>
                            </h:selectBooleanCheckbox>execute shakedown tests when deployed</label>
                        </h:panelGroup>
                    </div>

                    <div class="paddingLeft20">
                        <h:panelGroup
                                rendered="#{securityDataProvider.hasPermission('SHAKEDOWNTEST', 'CREATE')}">
                            <label class="inlineBlock">
                                <h:selectBooleanCheckbox id="testNeighbourhoodButtonId"
                                    disabled="#{deployScreenDataProvider.selectedDeployment.createTestAfterDeployment==false}"
                                    value="#{deployScreenDataProvider.selectedDeployment.createTestForNeighborhoodAfterDeployment}"/>
                                test neighbourhood
                            </label>
                        </h:panelGroup>
                    </div>

                    <a4j:commandLink render="deployments" value="Confirm"
                                     action="${deployScreenDataProvider.doConfirmAction(deployScreenDataProvider.selectedDeployment)}"
                                     styleClass="btn primary right marginLeft20"
                                     type="button"
                                     onclick="showLoader();#{rich:component('confirmDeployment')}.hide();"
                                     oncomplete="hideLoader();return false;"/>

                </h:panelGroup>
            </rich:popupPanel>
            <rich:popupPanel id="rejectDeployment" moveable="true"
                             autosized="true" domElementAttachment="form">
                <f:facet name="header">
                    <h2>
                        <h:outputText
                                value="Reject deployment ${deployScreenDataProvider.selectedDeployment.id} for appserver ${deployScreenDataProvider.selectedDeployment.resourceGroup.name}"
                                id="rejectDeploymentPopupPanelFacet"/>
                    </h2>
                </f:facet>
                <f:facet name="controls">
                    <h:outputLink value="#"
                                  styleClass="close icon icon-close icon-replace"
                                  onclick="#{rich:component('rejectDeployment')}.hide(); return false;">
                        x
                    </h:outputLink>
                </f:facet>
                <h:panelGroup id="rejectDeploymentPopupPanelGroup">
                    Are you sure that you want to reject this deployment?
                    <a4j:commandLink render="deployments"
                                     styleClass="btn primary right  marginLeft20" value="Confirm"
                                     type="button"
                                     action="${deployScreenDataProvider.doRejectAction(deployScreenDataProvider.selectedDeployment)}"
                                     onclick="showLoader();#{rich:component('rejectDeployment')}.hide();"
                                     oncomplete="hideLoader();return false;"/>
                </h:panelGroup>
            </rich:popupPanel>
            <rich:popupPanel id="cancelDeployment" moveable="true"
                             autosized="true" domElementAttachment="form">
                <f:facet name="header">
                    <h2>
                        <h:outputText
                                value="Cancel deployment ${deployScreenDataProvider.selectedDeployment.id} for appserver ${deployScreenDataProvider.selectedDeployment.resourceGroup.name}"
                                id="cancelDeploymentPopupPanelFacet"/>
                    </h2>
                </f:facet>
                <f:facet name="controls">
                    <h:outputLink value="#"
                                  styleClass="close icon icon-close icon-replace"
                                  onclick="#{rich:component('cancelDeployment')}.hide(); return false;">
                        x
                    </h:outputLink>
                </f:facet>
                <h:panelGroup id="cancelDeploymentPopupPanelGroup">
                    Are you sure that you want to cancel this deployment?
                    <a4j:commandLink render="deployments"
                                     styleClass="btn primary right  marginLeft20" value="Confirm"
                                     type="button"
                                     action="${deployScreenDataProvider.cancelDeployment(deployScreenDataProvider.selectedDeployment)}"
                                     onclick="showLoader();#{rich:component('cancelDeployment')}.hide();"
                                     oncomplete="hideLoader();return false;"/>
                </h:panelGroup>
            </rich:popupPanel>

        </h:form>

        <h:form prependId="false">
            <rich:popupPanel id="confirmDeployment" moveable="true"
                             autosized="true" domElementAttachment="form">
                <f:facet name="header">
                    <h2>
                        <h:outputText
                                value="Confirm deployment ${deployScreenDataProvider.selectedDeployment.id} for appserver ${deployScreenDataProvider.selectedDeployment.resourceGroup.name}"
                                id="confirmDeploymentPopupPanelFacet"/>
                    </h2>
                </f:facet>
                <f:facet name="controls">
                    <h:outputLink value="#"
                                  styleClass="close icon icon-close icon-replace"
                                  onclick="#{rich:component('confirmDeployment')}.hide(); return false;">
                        x
                    </h:outputLink>
                </f:facet>
                <h:panelGroup id="confirmDeploymentPopupPanelGroup">
                    Do you want to receive an email when deployed?
                    <br/>
                    <h:commandLink render="deployments" value="No"
                                   action="${deployScreenDataProvider.doConfirmAction(deployScreenDataProvider.selectedDeployment, false)}"
                                   styleClass="btn primary right marginLeft20" type="button"/>
                    <h:commandLink render="deployments" value="Yes"
                                   action="${deployScreenDataProvider.doConfirmAction(deployScreenDataProvider.selectedDeployment, true)}"
                                   styleClass="btn primary right marginLeft20" type="button"/>
                </h:panelGroup>
            </rich:popupPanel>
        </h:form>

        <h:form prependId="false">

            <rich:popupPanel id="cancelDeployment" moveable="true"
                             autosized="true" domElementAttachment="form">
                <f:facet name="header">
                    <h2>
                        <h:outputText
                                value="Cancel deployment ${deployScreenDataProvider.selectedDeployment.id} for appserver ${deployScreenDataProvider.selectedDeployment.resourceGroup.name}"
                                id="cancelDeploymentPopupPanelFacet"/>
                    </h2>
                </f:facet>
                <f:facet name="controls">
                    <h:outputLink value="#"
                                  styleClass="close icon icon-close icon-replace"
                                  onclick="#{rich:component('cancelDeployment')}.hide(); return false;">
                        x
                    </h:outputLink>
                </f:facet>
                <h:panelGroup id="cancelDeploymentPopupPanelGroup">
                    Are you sure that you want to cancel this deployment?
                    <h:commandLink styleClass="btn primary right marginLeft20"
                                   value="Confirm" type="button"
                                   action="${deployScreenDataProvider.cancelDeployment()}"
                                   render="deployments"/>
                </h:panelGroup>
            </rich:popupPanel>
        </h:form>


        <h:form prependId="false">

            <rich:popupPanel id="bulkEditPopupPanel" moveable="true"
                             autosized="true" minWidth="400" domElementAttachment="form">
                <f:facet name="header">
                    <h2>
                        <h:outputText value="Edit deployments"
                                      id="bulkEditPopupPanelFacet"/>
                    </h2>
                </f:facet>
                <f:facet name="controls">
                    <h:outputLink value="#"
                                  styleClass="close icon icon-close icon-replace"
                                  onclick="#{rich:component('bulkEditPopupPanel')}.hide(); return false;">
                        x
                    </h:outputLink>
                </f:facet>
                <h:panelGroup id="bulkEditPopupPanelGroup">
                    <h:panelGrid columns="2" styleClass="formGrid">
                        <h:outputLabel value="Action"/>
                        <h:selectOneMenu id="bulkAction"
                                         value="#{deployScreenDataProvider.bulkAction}">
                            <f:selectItems
                                    value="#{deployScreenDataProvider.deploymentActions}"
                                    var="action" itemLabel="#{action.label}" itemValue="#{action}"/>
                            <a4j:ajax render="bulkEditPopupPanelGroup"/>
                        </h:selectOneMenu>
                        <h:outputLabel value="Date"
                                       rendered="#{deployScreenDataProvider.bulkAction == 'CONFIRM' or deployScreenDataProvider.bulkAction == 'CHANGE_DATE'}"/>
                        <rich:calendar
                                buttonIcon="/AMW_web/images/calendarIcon.png"
                                buttonDisabledIcon="/AMW_web/images/calendarIcon.png"
                                rendered="#{deployScreenDataProvider.bulkAction == 'CONFIRM' or deployScreenDataProvider.bulkAction == 'CHANGE_DATE'}"
                                value="#{deployScreenDataProvider.deploymentDate}"
                                enableManualInput="true" showApplyButton="true"
                                datePattern="dd.MM.yyyy HH:mm">
                            <a4j:ajax/>
                        </rich:calendar>
                    </h:panelGrid>
                    <h:panelGroup id="bulkOptions" rendered="#{deployScreenDataProvider.bulkAction == 'CONFIRM'}">
                        <div>
                            <label class="inlineBlock">
                                <h:selectBooleanCheckbox
                                        value="#{deployScreenDataProvider.simulateGeneration}"/>simulate before deployment</label>
                        </div>
                        <div>
                            <label class="inlineBlock">
                                <h:selectBooleanCheckbox
                                        value="#{deployScreenDataProvider.sendEmailConfirmation}"/>send an email when deployed</label>
                        </div>
                        <h:panelGroup layout="block"
                                      rendered="#{securityDataProvider.hasPermission('SHAKEDOWNTEST', 'CREATE')}">
                            <label class="inlineBlock">
                                <h:selectBooleanCheckbox value="#{deployScreenDataProvider.executeShakedownTest}">
                                    <a4j:ajax render="bulkTestNeighbourhoodButtonId"/>
                                </h:selectBooleanCheckbox>execute shakedown tests when deployed</label>
                        </h:panelGroup>

                        <h:panelGroup layout="block" class="paddingLeft20"
                                      rendered="#{securityDataProvider.hasPermission('SHAKEDOWNTEST', 'CREATE')}">
                            <label class="inlineBlock"> <h:selectBooleanCheckbox
                                    id="bulkTestNeighbourhoodButtonId"
                                    disabled="#{deployScreenDataProvider.executeShakedownTest==false}"
                                    value="#{deployScreenDataProvider.neighbourhoodTest}"/>test neighbourhood</label>
                        </h:panelGroup>
                    </h:panelGroup>

                    <a4j:commandLink styleClass="btn primary right marginLeft20"
                                     value="Edit" type="button"
                                     action="${deployScreenDataProvider.bulkUpdateDeployments}"
                                     render="deployments"
                                     onclick="showLoader();#{rich:component('bulkEditPopupPanel')}.hide();"
                                     oncomplete="hideLoader();return false;"
                    />
                </h:panelGroup>
            </rich:popupPanel>
        </h:form>

        <h:form prependId="false">
            <rich:popupPanel id="changeDeploymentDatePopupPanel" moveable="true"
                             autosized="true" domElementAttachment="form">
                <f:facet name="header">
                    <h2>
                        <h:outputText value="Change deployment date"
                                      id="changeDeploymentDatePopupPanelFacet"/>
                    </h2>
                </f:facet>
                <f:facet name="controls">
                    <h:outputLink value="#"
                                  styleClass="close icon icon-close icon-replace"
                                  onclick="#{rich:component('changeDeploymentDatePopupPanel')}.hide(); return false;">
                        x
                    </h:outputLink>
                </f:facet>
                <h:panelGroup id="changeDeploymentDatePopupPanelGroup">

                    <table class="well">
                        <caption>
                            <h2>Deployment date</h2>
                        </caption>
                        <tbody>
                        <tr>
                            <td><rich:calendar
                                    buttonIcon="/AMW_web/images/calendarIcon.png"
                                    buttonDisabledIcon="/AMW_web/images/calendarIcon.png"
                                    value="#{deployScreenDataProvider.selectedDeployment.deploymentDate}"
                                    enableManualInput="true" showApplyButton="true"
                                    datePattern="dd.MM.yyyy HH:mm">
                                <a4j:ajax render="changeDeploymentDatePopupPanelGroup"/>
                            </rich:calendar></td>
                        </tr>
                        </tbody>
                    </table>


                    <a4j:commandLink styleClass="btn primary right marginLeft20" value="Save"
                                     type="submit"
                                     action="#{deployScreenDataProvider.changeDeploymentTime(deployScreenDataProvider.selectedDeployment)}"
                                     onclick="showLoader();#{rich:component('changeDeploymentDatePopupPanel')}.hide();"
                                     oncomplete="hideLoader();return false;" render="deployments"/>
                </h:panelGroup>
            </rich:popupPanel>
        </h:form>

        <h:form prependId="false">
            <rich:popupPanel id="deploymentDetailPopup" moveable="true"
                             autosized="true">
                <f:facet name="header">
                    <h2>
                        <h:outputText
                                value="Details for deployment #${deployScreenDataProvider.selectedDeployment.id} [trackingid: ${deployScreenDataProvider.selectedDeployment.trackingId}] application server: ${deployScreenDataProvider.selectedDeployment.resourceGroup.name}"
                                id="deploymentDetailPopupFacet"/>
                    </h2>
                </f:facet>
                <f:facet name="controls">
                    <h:outputLink value="#"
                                  styleClass="close icon icon-close icon-replace"
                                  onclick="#{rich:component('deploymentDetailPopup')}.hide(); return false;">
                        x
                    </h:outputLink>
                </f:facet>
                <h:panelGroup id="deploymentDetailPopupPanelGroup">

                    <ul>
                        <li><h:outputText
                                value="requested by: ${deployScreenDataProvider.selectedDeployment.deploymentRequestUser}"
                                styleClass="marginLeft10"/></li>
                        <li><h:outputText
                                value="created at: ${deployScreenDataProvider.formatDate(deployScreenDataProvider.selectedDeployment.deploymentJobCreationDate)}"
                                styleClass="marginLeft10"/></li>
                    </ul>
                    <h:panelGroup
                            rendered="${deployScreenDataProvider.selectedDeployment.deploymentConfirmed != null}">
                        <br/>
                        <ul>
                            <li><h:outputText
                                    value="${deployScreenDataProvider.selectedDeployment.deploymentConfirmed ? 'confirmed' : 'rejected'} by: ${deployScreenDataProvider.selectedDeployment.deploymentConfirmationUser}"
                                    styleClass="marginLeft10"/></li>
                            <li><h:outputText
                                    value="${deployScreenDataProvider.selectedDeployment.deploymentConfirmed ? 'confirmed' : 'rejected'} at: ${deployScreenDataProvider.formatDate(deployScreenDataProvider.selectedDeployment.deploymentConfirmationDate)}"
                                    styleClass="marginLeft10"/></li>
                        </ul>
                    </h:panelGroup>
                    <h:panelGroup
                            rendered="${deployScreenDataProvider.isDeploymentDelayed(deployScreenDataProvider.selectedDeployment)}">
                        <br/>
                        <h3>
                            <h:outputText value="deployment job delayed"/>
                        </h3>
                        <ul>
                            <li><h:outputText
                                    value="planed deployment date: ${deployScreenDataProvider.formatDate(deployScreenDataProvider.selectedDeployment.deploymentDate)}"
                                    styleClass="marginLeft10"/></li>
                        </ul>
                    </h:panelGroup>
                    <h:panelGroup
                            rendered="${deployScreenDataProvider.isDeploymentCanceled(deployScreenDataProvider.selectedDeployment)}">
                        <br/>
                        <h3>
                            <h:outputText value="deployment job canceled"/>
                        </h3>
                        <ul>
                            <li><h:outputText
                                    value="canceled by: ${deployScreenDataProvider.selectedDeployment.deploymentCancelUser}"
                                    styleClass="marginLeft10"/></li>
                            <li><h:outputText
                                    value="canceled at: ${deployScreenDataProvider.formatDate(deployScreenDataProvider.selectedDeployment.deploymentCancelDate)}"
                                    styleClass="marginLeft10"/></li>
                        </ul>

                    </h:panelGroup>

                    <h:panelGroup rendered="${deployScreenDataProvider.hasDeploymentParameter()}">
                        <br/>
                        <h:dataTable var="deployParam" id="deploymentParameterTable"
                                     value="#{deployScreenDataProvider.selectedDeployment.deploymentParameters}"
                                     styleClass="well" style="border-radius: 6px">
                            <f:facet name="header">
                                <h2>
                                    <h:outputText value="Deployment parameter"/>
                                </h2>
                            </f:facet>

                            <h:column index="index" headerClass="width_20 nowrap">

                                <h:outputText value="#{deployParam.key}"/>
                            </h:column>
                            <h:column index="index" headerClass="width_20 nowrap">
                                <h:outputText value="#{deployParam.value}"/>
                            </h:column>

                        </h:dataTable>
                    </h:panelGroup>

                    <h:panelGroup styleClass="well" layout="block"
                                  rendered="${deployScreenDataProvider.selectedDeployment.reason != null}">
                        <h2>
                            <h:outputText value="Failure reason"/>
                        </h2>
                        <hr/>
                        <div class="maxHeight500px width700px">
                            <h:outputText value="${deployScreenDataProvider.selectedDeployment.reason.displayName}"/>
                        </div>
                    </h:panelGroup>

                    <br/>
                    <h:panelGroup styleClass="well" layout="block"
                                  rendered="${deployScreenDataProvider.selectedDeployment.stateMessageAsHtml != ''}">
                        <h2>
                            <h:outputText value="State message"/>
                        </h2>
                        <hr/>
                        <div class="autoOverflow maxHeight500px width700px stateMessage">
                            <h:outputText
                                    value="${deployScreenDataProvider.selectedDeployment.stateMessageAsHtml}"
                                    escape="false"/>
                        </div>
                    </h:panelGroup>

                </h:panelGroup>
            </rich:popupPanel>
        </h:form>

        <a4j:region>
            <h:form id="pollform">
                <a4j:poll id="poll" interval="15000" enabled="false"
                          render="deployments"
                          action="#{deployScreenDataProvider.reloadDeployments(false)}"/>
            </h:form>
        </a4j:region>
    </ui:define>
</ui:composition>
</html>